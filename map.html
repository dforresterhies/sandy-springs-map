<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sandy Springs Family Map</title>

<!-- Leaflet core -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Search control -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet-control-search@2.9.9/dist/leaflet-search.min.css"/>
<script src="https://unpkg.com/leaflet-control-search@2.9.9/dist/leaflet-search.min.js"></script>

<!-- Papa Parse for CSV -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.popup-name{font-weight:bold}
.district-label{font-weight:bold;color:#333;text-shadow:0 0 3px #fff}
#filterBox{
  position:absolute;top:12px;right:12px;z-index:999;
  background:#fff;padding:4px;border:1px solid #ccc;border-radius:4px;
  font:14px Arial
}
#legend{
  position:absolute;bottom:12px;left:12px;background:#fff;
  border:1px solid #ccc;border-radius:4px;
  padding:8px 10px;font:12px/14px Arial;
  box-shadow:0 1px 4px rgba(0,0,0,.3);
}
#legend span.swatch{
  display:inline-block;width:14px;height:14px;margin-right:4px;border:1px solid #999
}
</style>
</head>
<body>
<div id="map"></div>
<select id="filterBox">
  <option value="all">All districts</option>
  <option value="1">District 1</option><option value="2">District 2</option>
  <option value="3">District 3</option><option value="4">District 4</option>
  <option value="5">District 5</option><option value="6">District 6</option>
</select>

<script>
// ──────────────────────────────────────────────────────────
// 0️⃣  District colours (sampled from city map)
const DIST_COLORS = {
  1:'#DDAE72', 2:'#5AA3E9', 3:'#78B478',
  4:'#9C59D1', 5:'#F48B3A', 6:'#E3CA55'
};

// 1️⃣  Base map
const map = L.map('map').setView([33.94,-84.37],12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            {attribution:'©OpenStreetMap, ©CARTO'}).addTo(map);

// 2️⃣  Council districts
const DIST_URL =
  'https://gis2.sandyspringsga.gov/arcgis/rest/services/OpenData/General_Reference/MapServer/104/query?where=1=1&outFields=*&outSR=4326&f=geojson';

let districtLayer;           // will hold polygons for filter toggling
fetch(DIST_URL).then(r=>r.json()).then(dJSON=>{
  districtLayer = L.geoJSON(dJSON,{
    style:f=>{
      const c=DIST_COLORS[f.properties.DISTRICT]||'#666';
      return {color:c,weight:1,fillColor:c,fillOpacity:.25}
    },
    onEachFeature:(f,l)=>{
      const centre=l.getBounds().getCenter();
      L.marker(centre,{
        icon:L.divIcon({className:'district-label',
                        html:`District ${f.properties.DISTRICT}`}),
        interactive:false
      }).addTo(map);
    }
  }).addTo(map);

  // 3️⃣  Load CSV & build markers once polygons are ready
  Papa.parse('families.csv',{
    header:true, download:true, dynamicTyping:true,
    complete: res=>initMarkers(res.data,dJSON)
  });
});

// ──────────────────────────────────────────────────────────
// Helper: point-in-polygon (Polygon & MultiPolygon)
function pointInFeature(x,y,feature){
  const rings = feature.geometry.type==='Polygon'
        ? [feature.geometry.coordinates[0]]
        : feature.geometry.coordinates.map(p=>p[0]);
  let inside=false;
  rings.forEach(vs=>{
    for(let i=0,j=vs.length-1;i<vs.length;j=i++){
      const xi=vs[i][0], yi=vs[i][1], xj=vs[j][0], yj=vs[j][1];
      const intersect=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi);
      if(intersect) inside=!inside;
    }
  });
  return inside;
}

// ──────────────────────────────────────────────────────────
// Build markers + clustering + search + filter
let cluster, allMarkers=[];

function initMarkers(rows,districtsJSON){
  cluster=L.markerClusterGroup();
  rows.forEach(r=>{
    const lat=+r.Lat, lon=+r.Lon;
    if(!lat||!lon) return;

    const feat=districtsJSON.features.find(f=>pointInFeature(lon,lat,f));
    const dist=feat?feat.properties.DISTRICT:'?';
    const colour=DIST_COLORS[dist]||'#999';

    const m=L.circleMarker([lat,lon],{
      radius:6,weight:1,color:'#333',fillColor:colour,fillOpacity:.9
    })
      .bindPopup(`<div class="popup-name">${r['All_Names']||'n/a'}</div>
                  District ${dist}<br>${r['Full Address']||''}`);

    m.options._dist = dist;          // store district for filtering
    m.options._name = r['All_Names'];// store name for search plugin
    cluster.addLayer(m);
    allMarkers.push(m);
  });
  map.addLayer(cluster);

  // ➊ Search control
  const searchCtrl=new L.Control.Search({
    layer: cluster,
    propertyName:'_name',
    marker:false,
    moveToLocation:(latlng,zoom,map)=>map.setView(latlng,Math.max(16,zoom))
  });
  map.addControl(searchCtrl);

  // ➋ District filter dropdown
  document.getElementById('filterBox').addEventListener('change',e=>{
    const val=e.target.value;
    cluster.clearLayers();
    districtLayer.eachLayer(l=>l.setStyle({fillOpacity:.25}));
    if(val==='all'){
      allMarkers.forEach(m=>cluster.addLayer(m));
    }else{
      allMarkers.filter(m=>m.options._dist==val)
                .forEach(m=>cluster.addLayer(m));
      districtLayer.eachLayer(l=>{
        if(l.feature.properties.DISTRICT!=val)
          l.setStyle({fillOpacity:.03});
      });
    }
  });
}

// ──────────────────────────────────────────────────────────
// Legend
const lg=document.createElement('div');
lg.id='legend'; lg.innerHTML='<b>District colours</b><br>';
Object.keys(DIST_COLORS).forEach(d=>{
  lg.innerHTML+=`<span class="swatch" style="background:${DIST_COLORS[d]}"></span>${d}&nbsp; `;
});
document.body.appendChild(lg);
</script>
</body>
</html>
